---
title: "Repositório Brasileiro Livre para Dados Abertos do Solo -- Guia Básico"
author: "Alessandro Samuel-Rosa"
date: "`r format(Sys.Date(), '%d-%m-%Y')`"
output:
  bookdown::html_document2:
    toc: true
    theme: united
vignette: >
  %\VignetteIndexEntry{Repositório Brasileiro Livre para Dados Abertos do Solo -- Guia Básico}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introdução

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
febr <- glue::glue('<font face="Comfortaa">febr</font>')
```

O pacote `febr` foi criado facilitar o acesso aos dados dos conjuntos de dados publicados no Repositório Brasileiro Livre para Dados Abertos do Solo -- `r febr`, http://www.ufsm.br/febr/. Ele ainda não está disponível no [CRAN][cran], mas a versão de desenvolvimento, disponível no [GitHub][github], pode ser instalada -- usando o pacote `devtools` -- da seguinte maneira:

[cran]: https://CRAN.R-project.org
[github]: https://github.com/febr-team/febr-package

```{r}
if (!require(devtools)) {
  install.packages(pkgs = "devtools")
}
devtools::install_github(repo = "febr-team/febr-package")
```

O pacote `febr` possui três grupos de funções: as funções estruturais, as funções de acesso, e as funções auxiliares. A forma de uso e aplicações dessas funções são demonstradas nas próximas seções.

## Funções estruturais

As funções estruturais servem para conhecer a estrutura das tabelas dos conjuntos de dados publicados no `r febr`. Elas também servem para conhecer os padrões de codificação, nomenclatura, unidades de medida e número de casas decimais usados no `r febr`.

A função `header` (do inglês, *header*, para cabeçalho) serve para descarregar o cabeçalho -- as duas primeiras linhas -- de uma das duas tabelas de dados -- `observacao` ou `camada` -- de um conjunto de dados publicado no `r febr`. Isso permite verificar quais são as variáveis incluídas num determinado conjunto de dados, os códigos de identificação utilizados, e as respectivas unidades de medida. Por exemplo, o cabeçalho completo da tabela `camada` do conjunto de dados `ctb0003` é descarregado da seguinte maneira:

```{r}
cab <- febr::header(dataset = "ctb0003", table = "camada", variable = "all")
```

A função `standard` (do inglês, *standard*, para padrão) fornece uma interface para descarregar informações sobre os padrões usados para as variáveis incluídas nas tabelas `observacao` e `camada` dos conjuntos de dados publicados no `r febr`. Isso inclui a codificação e nomenclatura, a descrição de cada variável, a unidade de medida e o número de casas decimais, o tipo de dado, e a categoria da variável. Tais informações estão organizadas numa tabela disponível em https://goo.gl/hi77sB. Por exemplo, caso tenhamos interesse em conhecer os padrões usados no `r febr` para as variáveis `argila`, `densidade`, `carbono` e `ph`, basta usar o seguinte código:

```{r}
pad <- febr::standard(variable = c("argila", "densidade", "carbono", "ph"))
```

A função `unit` (do inglês, *unit*, para unidade) serve de interface para uma tabela -- disponível em https://goo.gl/Vvvsf2 -- contendo diversas unidades de medida e as constantes utilizadas para a conversão dos dados entre elas. Por exemplo, no caso da densidade do solo, comumente expressa em `Mg/m^3` e `kg/dm^3`, a constante de transformação é igual a `1`. Essa informação é útil durante o descarregamento dos dados usando a função `layer` descrita abaixo. Para descarregar as unidades de medida e constantes de transformação basta usar o seguinte código:

```{r}
uni <- febr::unit(source = "Mg/m^3", target = "kg/dm^3")
```

## Funções de acesso

As funções de acesso servem para descarregar os dados e metadados dos conjuntos de dados publicados no `r febr`. Isso inclui as tabelas `dataset`, `observacao`, `camada`, e `metadado`.

Os dados sobre um conjunto de dados publicado no `r febr`, contidos na tabela `dataset` (do inglês, *dataset*, para conjunto de dados), podem ser descarregados usando uma função de mesmo nome. Para isso, basta informar o código do(s) conjunto(s) de dados que se deseja descarregar, por exemplo:

```{r}
conj <- febr::dataset(dataset = "ctb0003")
```

Já os dados sobre os dados contidos em um conjunto de dados, armazenados na tabela `metadado`, podem ser descarregados usando a função `metadata` (do inglês, *metadata*, para metadados), por exemplo:

```{r}
meta <- febr::metadata(dataset = "ctb0003")
```

Os dados das observações do solo, contidos na tabela `observacao` de um conjunto de dados, podem ser descarregados usando a função `observation` (do inglês, *observation*, para observação). Assim como as funções `header` e `standard` vistas acima, a função `observation` também possui o argumento `variable`, que permite selecionar as variáveis que devem ser retornadas. Por exemplo, para retornar apenas a variável `taxon`, usamos o seguinte código:

```{r}
obs <- febr::observation(dataset = "ctb0003", variable = "taxon")
```

A função `layer` (do inglês, *layer*, para camada) serve para descarregar os dados contidos na tabela `camada` de um conjunto de dados. Por exemplo, para descarregar os dados da tabela `camada` de dois conjuntos de dados com as variáveis `argila`, `carbono` e `densidade`, usamos o seguinte código:

```{r}
cam <- febr::layer(dataset = c("ctb0003", "ctb0036"), variable = c("argila", "carbono", "densidade"))
```

A última função de acesso é `febr`. Ela serve para descarregar todos os dados e metadados de um conjunto de dados. Essa função aceita os mesmos argumentos das funções `observation` e `layer` -- que são idênticos devido à similaridade da estrutura das tabelas `observacao` e `camada`. Assim, como naquelas funções, é possível solicitar que os dados passem por uma rotina de limpeza e padronização:

```{r}
tudo <- febr::febr(
  dataset = "ctb0003", variable = "all", merge = TRUE, 
  missing = list(coord = "drop", time = "drop", depth = "drop"),
  standardization = list(
    crs = "EPSG:4674", time.format = "%Y-%m-%d",
    repetition = "combine", combine.fun = "mean",
    transition = "smooth", smoothing.fun = "mean",
    plus.sign = "add", plus.depth = 2.5,
    lessthan.sign = "subtract", lessthan.frac = 0.1,
    units = TRUE, round = TRUE))
```

## Funções auxiliares

As funções auxiliares servem para realizar tarefas complementares às funções estruturais e de acesso, assim apoiando o processamento e uso dos dados descarregados do <font face="Comfortaa">febr</font>, por exemplo, a criação de objetos de outras classes e a exportação dos dados.

A função `febr2spdf` serve para criar um objeto de classe `SpatialPointsDataFrame` a partir da tabela `observacao` de um conjunto de dados. O código a seguir demonstra como fazer isso -- note que as funções do pacote `febr` são compatíveis com o uso do operador `%>%` do pacote `magrittr`:

```{r}
library(magrittr)
obs <- 
  febr::observation(dataset = "ctb0003", variable = "taxon") %>% 
  febr::febr2spdf()
```

Já a função `febr2xlsx` serve para escrever os dados de um conjunto de dados publicado no `r febr` para um arquivo no formato XLSX no disco rígido. No caso específico da função `febr`, que retorna um objeto de classe `list` composto de itens de classe `data.frame`, a função `febr2xlsx` escreve cada um dos `data.frame`s em uma planilha individual do mesmo arquivo no formato XLSX. Por exemplo,

```{r}
tudo <- 
  febr::febr(dataset = "ctb0003", variable = "all") %>% 
  febr::febr2xlsx(file = "ctb0003.xlsx")
```

A terceira função auxiliar do pacote `febr` é `goto`. A função `goto` serve de interface para navegação nas diversas páginas na Internet do `r febr`: página principal, visualização geográfica, catálogo de conjuntos de dados, página de busca, manual do mantenedor, pacote para R, GitHub, fórum de discussão, e tabelas com padrões de unidades de medida e de codificação e nomenclatura. Além disso, a função `goto` serve para visitar as diferentes tabelas dos conjuntos de dados publicados no `r febr`. Por exemplo, para visitar a tabela `camada` do conjunto de dados `ctb0036`, usa-se o seguinte código: 

```{r}
febr::goto(dataset = "ctb0036", table = "camada")
```

Novas funções auxiliares serão criadas à medida que as pessoas usuárias do pacote `febr` apontarem a sua necessidade. Alternativamente, as pessoas usuárias são encorajadas a submeter funções auxiliares para inclusão no pacote `febr` seguindo o modelo de desenvolvimento colaborativo *fork & pull*.
